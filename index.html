import { useEffect, useRef, useState } from 'react';
import { motion } from 'framer-motion';
import { Button } from "@/components/ui/button";

export default function MangoDash() {
  const [jumping, setJumping] = useState(false);
  const [position, setPosition] = useState(0);
  const [obstacles, setObstacles] = useState([]);
  const gameRef = useRef(null);
  const gravity = 2;

  // Handle jump
  useEffect(() => {
    const handleKeyDown = (e) => {
      if (e.code === 'Space' && !jumping) {
        setJumping(true);
        let jumpHeight = 0;
        const jumpInterval = setInterval(() => {
          if (jumpHeight < 100) {
            setPosition(prev => prev - 5);
            jumpHeight += 5;
          } else {
            clearInterval(jumpInterval);
            // Fall down
            const fallInterval = setInterval(() => {
              setPosition(prev => {
                if (prev < 0) return 0;
                return prev + gravity;
              });
              if (position >= 0) {
                clearInterval(fallInterval);
                setJumping(false);
              }
            }, 20);
          }
        }, 20);
      }
    };

    window.addEventListener('keydown', handleKeyDown);
    return () => window.removeEventListener('keydown', handleKeyDown);
  }, [jumping, position]);

  // Obstacle generation
  useEffect(() => {
    const interval = setInterval(() => {
      setObstacles(prev => [...prev, { id: Date.now(), left: 1000 }]);
    }, 2000);
    return () => clearInterval(interval);
  }, []);

  // Move obstacles
  useEffect(() => {
    const interval = setInterval(() => {
      setObstacles(prev => prev.map(obs => ({ ...obs, left: obs.left - 5 })).filter(obs => obs.left > -50));
    }, 20);
    return () => clearInterval(interval);
  }, []);

  return (
    <div className="relative w-full h-screen bg-gradient-to-b from-yellow-200 to-orange-300 overflow-hidden" ref={gameRef}>
      <div
        className="absolute bottom-0 left-20 w-20 h-20"
        style={{ transform: `translateY(${-position}px)` }}
      >
        <img
          src="/cubongio.png"
          alt="Cubongio"
          className="w-full h-full object-contain rounded shadow-lg"
        />
      </div>

      {obstacles.map(obs => (
        <div
          key={obs.id}
          className="absolute bottom-0 w-12 h-24 bg-red-600 rounded-md"
          style={{ left: obs.left }}
        ></div>
      ))}

      <div className="absolute top-4 left-4 bg-white p-2 px-4 rounded shadow text-xl font-bold">
        Stereo Mandess
      </div>

      <div className="absolute bottom-4 right-4">
        <Button onClick={() => window.location.reload()}>Reiniciar</Button>
      </div>
    </div>
  );
}
