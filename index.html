<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Super Mangonio Bros Mejorado</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      background: black;
    }
    canvas {
      display: block;
    }
  </style>
</head>
<body>
<canvas id="gameCanvas"></canvas>
<audio id="bgm" loop autoplay>
  <source src="music.mp3" type="audio/mpeg" />
</audio>
<script>
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");
const bgm = document.getElementById("bgm");

let width = window.innerWidth;
let height = window.innerHeight;
canvas.width = width;
canvas.height = height;

let keys = {};
let mouse = { left: false };
let gameStarted = false;
let gameOver = false;
let level = 1;
let cameraX = 0;
let lives = 3;

const GRAVITY = 0.4;
let FLOOR = height - 64;

let player = {
  x: 50, y: 300, vx: 0, vy: 0,
  width: 32, height: 32,
  grounded: false,
  big: false,
  fire: false
};

let enemies = [];
let powerUps = [];
let barriers = [];
let blocks = [];
let pipes = [];
let minions = [];
let stairs = [];

function loadImage(src) {
  const img = new Image();
  img.src = src;
  return img;
}

const bg = loadImage("background.png");
const mangonio = loadImage("mangonio.png");
const enemyImg = loadImage("umpalumpa.png");
const pipeImg = loadImage("tuberia.png");
const minionImg = loadImage("minion.png");

document.addEventListener("keydown", e => {
  keys[e.key.toLowerCase()] = true;
  // También detectar flechas:
  if (e.key === "ArrowLeft") keys["arrowleft"] = true;
  if (e.key === "ArrowRight") keys["arrowright"] = true;
  if (e.key === "ArrowUp") keys["arrowup"] = true;

  if ((e.key.toLowerCase() === "q") && (!gameStarted || gameOver)) {
    gameStarted = true;
    gameOver = false;
    lives = 3;
    level = 1;
    resetLevel();
    bgm.play();
  }
});
document.addEventListener("keyup", e => {
  keys[e.key.toLowerCase()] = false;
  if (e.key === "ArrowLeft") keys["arrowleft"] = false;
  if (e.key === "ArrowRight") keys["arrowright"] = false;
  if (e.key === "ArrowUp") keys["arrowup"] = false;
});
canvas.addEventListener("mousedown", e => {
  if (e.button === 0) mouse.left = true;
});
canvas.addEventListener("mouseup", e => {
  if (e.button === 0) mouse.left = false;
});

function resetLevel() {
  player.x = 50;
  player.y = 300;
  player.vx = 0;
  player.vy = 0;
  cameraX = 0;

  if (level === 1) {
    barriers = [{ x: -50, y: 0, width: 100, height: height }];
  } else {
    barriers = [];
  }

  enemies = [
    { x: 600, y: FLOOR - 24, width: 24, height: 24, dir: 1, speed: 1 },
    { x: 900, y: FLOOR - 24, width: 24, height: 24, dir: -1, speed: 1 }
  ];

  powerUps = [];

  blocks = [];

  pipes = [
    { x: 700, y: FLOOR - 48, width: 64, height: 48 }
  ];

  // Escaleras sólidas detrás del tubo, justo antes:
  stairs = [
    { x: 660, y: FLOOR - 80, width: 40, height: 32 },  // Ajusta posición y tamaño como quieras
  ];

  minions = [
    { x: 700, y: FLOOR - 64, width: 32, height: 32, vy: -0.5 }
  ];
}

// Chequeo de colisiones AABB simplificado
function checkCollision(a, b) {
  return a.x < b.x + b.width &&
         a.x + a.width > b.x &&
         a.y < b.y + b.height &&
         a.y + a.height > b.y;
}

// Chequeo solo de colisión vertical (para suelo/plataformas)
function checkVerticalCollision(a, b) {
  return a.x < b.x + b.width &&
         a.x + a.width > b.x &&
         a.y + a.height <= b.y + 5 &&  // Pequeño margen para "aterrizar"
         a.y + a.height + a.vy >= b.y;
}

function update() {
  if (!gameStarted || gameOver) return;

  // Movimiento horizontal con WASD y flechas
  let left = keys["a"] || keys["arrowleft"];
  let right = keys["d"] || keys["arrowright"];
  player.vx = (left ? -3 : 0) + (right ? 3 : 0);

  // Salto con W, espacio, flecha arriba o clic izquierdo
  let jump = keys["w"] || keys[" "] || keys["arrowup"] || mouse.left;
  if (jump && player.grounded) {
    player.vy = -8;
    player.grounded = false;
  }

  player.vy += GRAVITY;
  player.x += player.vx;
  player.y += player.vy;

  // Suelo normal
  if (player.y + player.height >= FLOOR) {
    player.y = FLOOR - player.height;
    player.vy = 0;
    player.grounded = true;
  }

  // Colisión con barreras (solo a la izquierda para no atravesar)
  for (let barrier of barriers) {
    if (checkCollision(player, barrier)) {
      if (player.vx < 0) {
        player.x = barrier.x + barrier.width;
      }
    }
  }

  // Colisión con escaleras sólidas (stairs)
  for (let stair of stairs) {
    if (checkVerticalCollision(player, stair)) {
      player.y = stair.y - player.height;
      player.vy = 0;
      player.grounded = true;
    }
  }

  // Colisión con tuberías sólidas (pipes) - el jugador puede pararse encima y no atravesar lados
  pipes.forEach(pipe => {
    // Arriba - para poder pararse
    if (checkVerticalCollision(player, pipe)) {
      player.y = pipe.y - player.height;
      player.vy = 0;
      player.grounded = true;
    }
    // Lados: izquierda y derecha bloquean paso
    if (checkCollision(player, pipe)) {
      if (player.vx > 0) { // derecha
        player.x = pipe.x - player.width;
      } else if (player.vx < 0) { // izquierda
        player.x = pipe.x + pipe.width;
      }
    }
  });

  // Minion movimiento vertical
  minions.forEach(minion => {
    minion.y += minion.vy;
    if (minion.y < FLOOR - 90) minion.vy = 0.5;
    if (minion.y > FLOOR - 64) minion.vy = -0.5;
  });

  // Enemigos movimiento y colisión con tuberías sólidas
  enemies.forEach(e => {
    e.x += e.dir * e.speed;

    // Evitar que atraviesen los bordes del mundo
    if (e.x < 0) e.dir = 1;
    if (e.x > 1400) e.dir = -1;

    // Colisión con tuberías (evitan pasar)
    pipes.forEach(pipe => {
      if (checkCollision(e, pipe)) {
        // Cambian dirección al tocar tubería
        if
